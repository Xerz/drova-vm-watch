worker_processes auto;
events { worker_connections 1024; }

rtmp {
    server {
        listen ${RTMP_PORT};
        chunk_size 4096;

        application live {
            live on;
            record all manual;
            record_path /recordings/$name;
            record_suffix _%Y-%m-%d_%H-%M-%S.flv;
            record_unique on;

            on_publish http://127.0.0.1:${HTTP_PORT}/auth_stream;
        }
    }
}

http {
    server {
        listen ${HTTP_PORT};

        # Проверка токена стрима
        location /auth_stream {
            internal;
            if ($arg_token != "${STREAM_TOKEN}") {
                return 403;
            }
            return 200;
        }

        # Управление записью по имени потока
        location /control {
            if ($arg_token != "${CONTROL_TOKEN}") {
                return 403;
            }

            set $stream_name $arg_stream;

            if ($stream_name = "") {
                return 400 "Missing stream name\n";
            }

            if ($arg_action = "start") {
                exec_record start live $stream_name;
                return 200 "Started recording $stream_name\n";
            }

            if ($arg_action = "stop") {
                exec_record stop live $stream_name;
                return 200 "Stopped recording $stream_name\n";
            }

            return 400 "Invalid action\n";
        }
    }
}
